<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Grin & Glisten</title>
  <link rel="icon" type="image/png" href="/images/GG.png">

  <!-- Google font preload -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pirata+One&display=swap" rel="stylesheet">

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Feather icons -->
  <script src="https://unpkg.com/feather-icons"></script>

  <!-- Snipcart -->
  <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.3.0/default/snipcart.css" />
  <script async src="https://cdn.snipcart.com/themes/v3.3.0/default/snipcart.js"></script>

  <style>
    /* ---------- fonts, variables and base ---------- */
    @font-face { font-family: "Monument Extended"; src: url("/fonts/MonumentExtended-FreeForPersonalUse/MonumentExtended-Regular.woff2") format("woff2"), url("/fonts/MonumentExtended-FreeForPersonalUse/MonumentExtended-Regular.ttf") format("truetype"); font-weight:400; font-style:normal; font-display:swap; }
    @font-face { font-family: "Monument Extended Ultrabold"; src: url("/fonts/MonumentExtended-FreeForPersonalUse/MonumentExtended-Ultrabold.otf") format("opentype"); font-weight:900; font-style:normal; font-display:swap; }
    @font-face { font-family: "Plunct"; src: url("/fonts/Plunct(1).woff2") format("woff2"); font-weight:400 800; font-style:normal; font-display:swap; }
    @font-face { font-family: 'Pirata One'; src: url('/fonts/PirataOne-Regular.ttf') format('truetype'); font-weight:400; font-style:normal; font-display:swap; }

    :root { --gold:#D4AF37; --gold-dark:#B58826; --black:#000; --white:#fff; --veer-deep:#B30000; }

    html{ font-size:112.5%; }
    html,body{ font-family:"Pirata One","Monument Extended",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; margin:0; color:var(--black); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

    .plunct{ font-family:"Plunct","Pirata One","Monument Extended",sans-serif; font-weight:700; }
    .veerwear{ font-family:"Monument Extended Ultrabold","Monument Extended","Pirata One",sans-serif; color:var(--veer-deep); font-weight:900; text-transform:uppercase; letter-spacing:0.6px; }
    .monument{ font-family:"Monument Extended","Pirata One",sans-serif; font-weight:700; }

    .bag-count{ font-family:"Monument Extended Ultrabold","Monument Extended",sans-serif; font-weight:900; font-size:11px; line-height:1; }

    /* ---- select-with-icon: hide native arrow and position custom icon ---- */
    .select-with-icon { position: relative; display: inline-flex; align-items:center; vertical-align:middle; }
    .select-with-icon i, .select-with-icon svg { position:absolute; right:12px; top:50%; transform:translateY(-50%); pointer-events:none; z-index:2; width:18px; height:18px; display:block; }
    .select-with-icon select { -webkit-appearance:none; -moz-appearance:none; appearance:none; background-image:none; padding-left:12px; padding-right:44px; height:38px; line-height:1; border-radius:6px; border:1px solid var(--black); color:var(--black); background:white; z-index:1; }

    /* Hero */
    .shop-hero {
      position: relative;
      background-image: url('/images/fantasmagorie.gif');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      color:#fff;
      overflow:visible; /* ensure dropdown can overlap if needed */
      padding-top:8rem;
      padding-bottom:8rem;
      min-height:60vh;
      display:flex;
      align-items:center;
    }
    .shop-hero .overlay{ position:absolute; inset:0; background:rgba(0,0,0,0.35); pointer-events:none; }
    .shop-hero .hero-inner{ position:relative; z-index:2; }

    /* filter panel sticky */
    .filter-panel{ position:sticky; top:96px; max-height:calc(100vh - 110px); overflow:auto; padding-right:8px; }
    .filter-panel::-webkit-scrollbar{ width:8px; } .filter-panel::-webkit-scrollbar-thumb{ background:rgba(0,0,0,0.08); border-radius:6px; }

    .merch-inline-img{ width:20px; height:20px; object-fit:contain; margin-right:8px; display:inline-block; vertical-align:middle; }
    .badge-gold{ background:var(--gold); color:#000; font-weight:900; padding:4px 8px; border-radius:6px; font-size:11px; }

    .product-card{ border:1px solid rgba(0,0,0,0.06); box-shadow:0 6px 18px rgba(0,0,0,0.06); transition:transform .18s ease, box-shadow .18s ease; }
    .product-card:hover{ transform:translateY(-6px); box-shadow:0 14px 30px rgba(0,0,0,0.08); }

    /* pagination buttons styling */
    .page-btn {
      transition: all .16s ease;
      background: transparent;
      border: 1px solid rgba(0,0,0,0.12);
      width: 40px; height:40px;
      display:flex; align-items:center; justify-content:center;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
      background-clip: padding-box;
      position: relative; /* required for glow pseudo element */
      z-index: 2;
      overflow: visible; /* allow pseudo elements to be visible */
    }
    .page-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 18px rgba(0,0,0,0.06); }
    .page-btn.clicked { transform: scale(.98); }

    /* active page: stronger glow & sparkle */
    .page-active {
      background: linear-gradient(180deg,#fff9e6,#f7e5b8);
      color: #000;
      border: 1px solid rgba(0,0,0,0.18);
      transform: translateY(-4px) scale(1.04);
      box-shadow: 0 14px 38px rgba(0,0,0,0.12);
      overflow: visible;
    }

    .page-active::before{
      content: "";
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%);
      width: 220%;
      height: 220%;
      border-radius: 16px;
      z-index: -2;
      background: radial-gradient(circle at 50% 30%,
                  rgba(255,255,255,0.95) 0%,
                  rgba(250,250,240,0.9) 6%,
                  rgba(212,175,55,0.28) 20%,
                  rgba(212,175,55,0.14) 30%,
                  rgba(0,0,0,0) 70%);
      filter: blur(28px);
      pointer-events: none;
    }

    .page-active::after{
      content: "";
      position: absolute;
      right: 8px;
      top: 6px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      z-index: 3;
      pointer-events: none;
      background: radial-gradient(circle, rgba(255,255,255,1) 0 20%, rgba(255,255,255,0.8) 21% 45%, rgba(255,255,255,0) 46%);
      box-shadow: 0 0 12px rgba(212,175,55,0.75), 0 0 2px rgba(255,255,255,0.9);
      transform-origin: center;
      animation: sparkle 1.6s infinite ease-in-out;
      opacity: 1;
    }
    @keyframes sparkle {
      0%   { transform: translateY(0) scale(0.6) rotate(0deg); opacity:0; }
      25%  { transform: translateY(-4px) scale(1.15) rotate(18deg); opacity:1; }
      55%  { transform: translateY(-6px) scale(0.95) rotate(-10deg); opacity:0.9; }
      100% { transform: translateY(0) scale(0.7) rotate(0deg); opacity:0; }
    }

    /* nav arrow buttons */
    .nav-btn { transition: all .12s ease; display:flex; align-items:center; justify-content:center; width:40px; height:40px; border-radius:8px; border:1px solid rgba(0,0,0,0.08); background:transparent; cursor:pointer; }
    .nav-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 18px rgba(0,0,0,0.06); }
    .nav-btn.clicked { transform: scale(.96); opacity:.95; }

    /* heart styling */
    .heart-btn{ background:rgba(255,255,255,0.85); border-radius:9999px; width:40px; height:40px; display:flex; align-items:center; justify-content:center; }
    .heart-active{ background:var(--gold); color:#000 !important; }

    /* header icons container */
    .header-actions{ display:flex; align-items:center; justify-content:space-between; width:140px; position:relative; } /* position relative kept for stacking */

    /* ---- Dropdown menu (All Products) styling: white backing + left-aligned text ---- */
    .group{ position: relative; display: inline-block; } /* keep this for the trigger, but menu is moved to body */
    .menu-trigger{ display:flex; align-items:center; gap:8px; background:transparent; border:none; cursor:pointer; padding:0; }
    .menu-label{ display:inline-block; }

    /* dropdown will be positioned as fixed (moved to document.body by JS) */
    .dropdown-menu{
      position: fixed;
      background: #fff;
      color: var(--black);
      border-radius: 10px;
      box-shadow: 0 12px 36px rgba(0,0,0,0.12);
      padding: 6px 12px;     /* explicit left/right padding used by the positioning logic */
      z-index: 9999;
      display: none;
      white-space: nowrap;
      pointer-events: auto;
      min-width: 120px;
    }
    .dropdown-menu.open { display: block; }

    .dropdown-menu a{
      display:inline-block;
      padding: 8px 6px;
      color: var(--black);
      text-align: left;
      border-radius: 6px;
      width: 100%;
    }
    .dropdown-menu a:hover{ background: #f7f7f7; }

    .dropdown-menu a.veerwear { color: var(--veer-deep); font-weight:900; }

    /* filter toggle style */
    .filter-toggle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      width:100%;
      background:transparent;
      border:none;
      padding:0;
      cursor:pointer;
      font:inherit;
    }
    .filter-toggle .chev{ margin-left:12px; flex:0 0 auto; }

    /* make a little more space after the price body */
    #price-body { margin-bottom: 1.5rem; padding-bottom: 0.25rem; }

    /* mobile hamburger styling (visible on small screens) */
    #mobileMenuBtn { display:none; background:transparent; border:none; padding:8px; cursor:pointer; }
    @media (max-width:767px){
      #mobileMenuBtn { display:inline-flex; align-items:center; justify-content:center; }
      .hidden.md\\:flex { display:none !important; }
      .header-actions{ width:120px; }
      .dropdown-menu{ min-width: 180px; }
      .filter-toggle{ padding:6px 0; }

      /* Hide desktop inline search on mobile */
      .search-wrap .search-input { display:none !important; width:0 !important; opacity:0 !important; position:static !important; }
    }

    .menu-trigger:focus { outline: 2px solid rgba(212,175,55,0.45); outline-offset: 2px; border-radius:6px; }

    /* ----------------------------
       Header search UI
       - expands to the left on desktop
       - small, unobtrusive
       - input is positioned absolutely (so other icons never move)
    ---------------------------- */
    .search-wrap { position:relative; display:inline-flex; align-items:center; gap:8px; }
    .search-form { display:flex; align-items:center; }

    /* Make the input absolute so it doesn't affect layout; anchor to right of the search button */
    .search-input {
      position: absolute;
      right: 44px; /* leave space for the search button (36px) + small gap */
      width: 0;
      opacity: 0;
      transition: width .22s cubic-bezier(.2,.9,.3,1), opacity .18s ease;
      border:1px solid rgba(0,0,0,0.08);
      padding:8px 10px;
      border-radius:8px;
      font-size:0.95rem;
      outline:none;
      background:#fff;
      color:var(--black);
      transform-origin: right center; /* expands from right */
      box-shadow: 0 6px 18px rgba(0,0,0,0.04);
      z-index: 60; /* sit above nav items */
      white-space:nowrap;
    }
    /* visible state */
    .search-wrap.open .search-input {
      width: 220px;
      opacity: 1;
    }
    /* search button smaller look */
    .search-btn {
      width:36px;
      height:36px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:8px;
      background:transparent;
      border:none;
      cursor:pointer;
      padding:0;
      z-index: 65; /* above input so icon remains clickable */
    }
    .search-btn:focus { outline: 2px solid rgba(212,175,55,0.25); outline-offset:2px; border-radius:8px; }

    /* Mobile search inside mobileNav */
    #mobileSearchBar { display:none; padding:8px 16px; border-bottom:1px solid rgba(0,0,0,0.04); }
    #mobileSearchBar form { display:flex; gap:8px; align-items:center; }
    #mobileSearchBar input { flex:1; padding:10px 12px; border-radius:8px; border:1px solid rgba(0,0,0,0.08); }
    #mobileSearchBar button { padding:8px 10px; border-radius:8px; }

    /* show mobile search area when class added */
    .mobile-search-open #mobileSearchBar { display:block; }

    /* small helper to visually group subtype checkboxes */
    .subtype-group { font-size:0.85rem; margin-bottom:0.5rem; display:block; color:var(--black); }
    .subtype-heading { font-weight:700; margin-top:0.5rem; margin-bottom:0.25rem; font-size:0.85rem; color:rgba(0,0,0,0.9); }

    /* ================== NEW: Applied filters pill ================== */
    .applied-pill {
      display:inline-flex;
      gap:8px;
      align-items:center;
      background: linear-gradient(90deg, rgba(212,175,55,0.12), rgba(255,255,255,0.9));
      border:1px solid rgba(212,175,55,0.18);
      color:var(--black);
      padding:6px 10px;
      border-radius:999px;
      font-weight:700;
      font-size:0.9rem;
      box-shadow:0 6px 18px rgba(0,0,0,0.04);
    }
    .applied-pill .pill-close {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:22px;
      height:22px;
      border-radius:999px;
      background:transparent;
      border: none;
      cursor:pointer;
      font-size:14px;
    }
  </style>
</head>
<body class="monument">
  <!-- NAV -->
  <nav class="bg-white text-black shadow-md sticky top-0 z-50">
    <div class="container mx-auto px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-6 min-w-0">
        <!-- Mobile hamburger (visible < md) -->
        <button id="mobileMenuBtn" aria-label="Open menu" class="md:hidden">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7h18M3 12h18M3 17h18"></path></svg>
        </button>

        <a href="/Home/" class="flex items-center">
          <span class="monument text-2xl" style="font-weight:900; color:var(--black);">Grin & Glisten</span>
        </a>

        <div class="hidden md:flex space-x-8">
          <div class="group" id="all-products-group">
            <!-- trigger -->
            <button class="menu-trigger monument text-black" aria-expanded="false" aria-haspopup="true" id="allProductsTrigger">
              <span class="menu-label">All Products</span>
              <i data-feather="chevron-down" class="w-4 h-4"></i>
            </button>

            <!-- dropdown menu (white backing, auto width) -->
            <div class="dropdown-menu rounded-md" role="menu" aria-hidden="true" id="allProductsMenu">
              <div class="grid grid-cols-1 gap-0">
                <a href="/AllProducts/" class="monument">All Products</a>
                <div style="height:1px;background:#eee;margin:4px 0;"></div>
                <a href="/Grillz/" class="monument">Grillz</a>
                <a href="/NailJewelry/" class="monument">Nail Jewelry</a>
                <a href="/Earrings/" class="monument">Earrings</a>
                <!-- Veerwear and aL vaLe removed from dropdown as requested -->
              </div>
            </div>
          </div>

          <a href="/HowToOrder/" class="monument hover:text-amber-600 text-black">How to Order</a>
          <a href="/ImpressionKit/" class="monument hover:text-amber-600 text-black">Impression Kit</a>
          <a href="/Gallery/" class="monument hover:text-amber-600 text-black">Gallery</a>
          <a href="/contact/" class="monument hover:text-amber-600 text-black">Contact Us</a>

        </div>
      </div>

      <!-- header icons: search, heart, cart -->
      <div class="header-actions">
        <!-- SEARCH WRAP: desktop expands left. On mobile the icon will open mobile nav & focus mobile search. -->
        <div class="search-wrap" id="desktopSearchWrap" aria-hidden="false">
          <form id="headerSearchForm" class="search-form" role="search" action="/search.html" method="get">
            <input id="headerSearchInput" name="q" type="search" class="search-input" placeholder="Search products..." aria-label="Search products">
            <!-- search button: when collapsed clicking it opens input; when open form submit -->
            <button id="headerSearchBtn" type="submit" class="search-btn" aria-label="Search">
              <i data-feather="search" class="w-4 h-4"></i>
            </button>
          </form>
        </div>

        <a href="/favorites.html" class="text-black flex items-center justify-center" id="headerFavorites" aria-label="Favorites">
          <i data-feather="heart" class="w-5 h-5"></i>
        </a>

        <a href="#" id="headerCartToggle" class="relative snipcart-checkout text-black nav-btn" aria-label="Cart">
          <i data-feather="shopping-bag" class="w-5 h-5"></i>
          <span class="absolute -top-2 -right-2 bg-amber-600 text-black text-xs rounded-full w-5 h-5 flex items-center justify-center bag-count">
            <span class="snipcart-items-count">0</span>
          </span>
        </a>
      </div>
    </div>

    <!-- mobile nav -->
    <div id="mobileNav" class="md:hidden" style="display:none;">
      <div class="flex items-center justify-between mb-4 px-4">
        <div class="flex items-center gap-3">
          <img src="/images/vale-logo-removebg-preview.png" alt="vaLe" class="w-8 h-8 object-contain">
          <span class="monument text-lg" style="font-weight:900; color:var(--black);">Grin & Glisten</span>
        </div>
        <button id="mobileCloseBtn" class="p-2" title="Close menu"><i data-feather="x"></i></button>
      </div>

      <!-- Mobile search area (toggled by header search icon on small screens) -->
      <div id="mobileSearchBar" aria-hidden="true">
        <form id="mobileSearchForm" action="/search.html" method="get" role="search">
          <input id="mobileSearchInput" name="q" type="search" placeholder="Search products..." aria-label="Search products">
          <button type="submit" class="bg-amber-600 text-black px-3 py-2 rounded monument">Search</button>
        </form>
      </div>

      <div class="space-y-3 monument px-4">
        <a href="/Home/" class="block py-2 border-b">HOME</a>
        <div class="pt-2 pb-2 border-b">
          <div class="font-medium mb-2">All Products</div>
          <a href="/Grillz/" class="block py-1">Grillz</a>
          <a href="/NailJewelry/" class="block py-1">Nail Jewelry</a>
          <a href="/Earrings/" class="block py-1">Earrings</a>
          <!-- VEERWEAR and aL vaLe removed from mobile All Products list as well -->
        </div>

        <a href="/HowToOrder/" class="block py-2 border-b">How to Order</a>
        <a href="/ImpressionKit/" class="block py-2 border-b">Impression Kit</a>
        <a href="/Gallery/" class="block py-2 border-b">Gallery</a>
        <a href="/contact/" class="block py-2 border-b">Contact Us</a>

        <!-- mobile favorites link -->
        <a href="/favorites.html" class="block py-2 border-b">Favorites</a>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <section class="shop-hero text-white">
    <div class="overlay" aria-hidden="true"></div>
    <div class="container mx-auto px-6 hero-inner">
      <div class="shop-banner">
        <div>
          <h1 class="monument text-5xl md:text-6xl mb-4" style="font-weight:900;">Shop All Products</h1>
          <div class="flex items-center text-gray-200 text-sm monument">
            <a href="/Home/" class="hover:text-white text-gray-200">Home</a>
            <i data-feather="chevron-right" class="mx-2 w-4 h-4"></i>
            <span>All Products</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CONTENT -->
  <section class="py-12">
    <div class="container mx-auto px-6">
      <div class="flex flex-col md:flex-row gap-8">
        <aside class="md:w-1/4">
          <div class="bg-white p-6 rounded-lg filter-panel monument">
            <h3 class="font-medium text-lg mb-4" style="color:var(--black);">Filter By</h3>

            <!-- Category -->
            <div class="filter-section">
              <button class="filter-toggle" data-target="category-body">
                <span style="color:var(--black);">Category</span>
                <i data-feather="chevron-down" class="chev" id="chev-category"></i>
              </button>
              <div id="category-body" class="mt-3">
                <div class="space-y-2">
                  <div class="flex items-center">
                    <input type="checkbox" id="grillz" value="Grillz" class="filter-cat mr-2">
                    <label for="grillz" class="text-sm" style="color:var(--black);">Grillz</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="earrings" value="Earrings" class="filter-cat mr-2">
                    <label for="earrings" class="text-sm" style="color:var(--black);">Earrings</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="nails" value="Nail Jewelry" class="filter-cat mr-2">
                    <label for="nails" class="text-sm" style="color:var(--black);">Nail Jewelry</label>
                  </div>
                  <!-- Removed aL vaLe and Veerwear checkboxes per request -->
                </div>
              </div>
            </div>

            <!-- Subtype (new) -->
            <div class="filter-section mt-4">
              <button class="filter-toggle" data-target="subtype-body">
                <span style="color:var(--black);">Subtype</span>
                <i data-feather="chevron-down" class="chev" id="chev-subtype"></i>
              </button>
              <div id="subtype-body" class="mt-3">
                <!-- Organized by parent category to make it scannable -->
                <div class="subtype-heading">Earrings</div>
                <label class="subtype-group"><input type="checkbox" class="filter-subtype mr-2" value="Hoops"> Hoops</label>
                <label class="subtype-group"><input type="checkbox" class="filter-subtype mr-2" value="Studs"> Studs</label>
                <label class="subtype-group"><input type="checkbox" class="filter-subtype mr-2" value="Dangles"> Dangles</label>

                <div class="subtype-heading">Nail Jewelry</div>
                <label class="subtype-group"><input type="checkbox" class="filter-subtype mr-2" value="Full-Cover Press-Ons"> Full-Cover Press-Ons</label>
                <label class="subtype-group"><input type="checkbox" class="filter-subtype mr-2" value="Accent Tips"> Accent Tips</label>
                <label class="subtype-group"><input type="checkbox" class="filter-subtype mr-2" value="Resin-Embedded Nails"> Resin-Embedded</label>

                <div class="subtype-heading">Grillz</div>
                <label class="subtype-group"><input type="checkbox" class="filter-subtype mr-2" value="Full-Cover Sets"> Full-Cover Sets</label>
                <label class="subtype-group"><input type="checkbox" class="filter-subtype mr-2" value="Half-Cover / Open-Face"> Half-Cover / Open-Face</label>
                <label class="subtype-group"><input type="checkbox" class="filter-subtype mr-2" value="Top Sets"> Top Sets</label>
                <label class="subtype-group"><input type="checkbox" class="filter-subtype mr-2" value="Bottom Sets"> Bottom Sets</label>
                <label class="subtype-group"><input type="checkbox" class="filter-subtype mr-2" value="Single-Tooth / Cap"> Single-Tooth / Cap</label>
                <label class="subtype-group"><input type="checkbox" class="filter-subtype mr-2" value="Resin-Embedded Specials"> Resin-Embedded Specials</label>
              </div>
            </div>

            <!-- Technique / Features (new) -->
            <div class="filter-section mt-4">
              <button class="filter-toggle" data-target="feature-body">
                <span style="color:var(--black);">Features / Technique</span>
                <i data-feather="chevron-down" class="chev" id="chev-feature"></i>
              </button>
              <div id="feature-body" class="mt-3">
                <div class="space-y-2">
                  <div class="flex items-center">
                    <input type="checkbox" id="feat-fullcover" value="Full-Cover" class="filter-tech mr-2">
                    <label for="feat-fullcover" class="text-sm" style="color:var(--black);">Full-Cover</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="feat-resin" value="Resin-Embedded" class="filter-tech mr-2">
                    <label for="feat-resin" class="text-sm" style="color:var(--black);">Resin-Embedded</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="feat-accent" value="Accent" class="filter-tech mr-2">
                    <label for="feat-accent" class="text-sm" style="color:var(--black);">Accent / Single Pieces</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="feat-3d" value="3D Sculpt" class="filter-tech mr-2">
                    <label for="feat-3d" class="text-sm" style="color:var(--black);">3D / Sculpt</label>
                  </div>
                </div>
              </div>
            </div>

            <!-- other filters (materials) -->
            <div class="filter-section mt-4">
              <button class="filter-toggle" data-target="material-body">
                <span style="color:var(--black);">Material</span>
                <i data-feather="chevron-down" class="chev" id="chev-material"></i>
              </button>
              <div id="material-body" class="mt-3">
                <div class="space-y-2">
                  <div class="flex items-center">
                    <input type="checkbox" id="gold" value="Gold" class="filter-material mr-2">
                    <label for="gold" class="text-sm" style="color:var(--black);">Gold</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="silver" value="Silver" class="filter-material mr-2">
                    <label for="silver" class="text-sm" style="color:var(--black);">Silver</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="platinum" value="Platinum" class="filter-material mr-2">
                    <label for="platinum" class="text-sm" style="color:var(--black);">Platinum</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="with-diamonds" value="With Diamonds" class="filter-material mr-2">
                    <label for="with-diamonds" class="text-sm" style="color:var(--black);">With Diamonds</label>
                  </div>
                  <div class="flex items-center">
                    <input type="checkbox" id="resin" value="Resin" class="filter-material mr-2">
                    <label for="resin" class="text-sm" style="color:var(--black);">Resin</label>
                  </div>
                </div>
              </div>
            </div>

            <div class="filter-section">
              <button class="filter-toggle" data-target="price-body">
                <span style="color:var(--black);">Price Range</span>
                <i data-feather="chevron-down" class="chev" id="chev-price"></i>
              </button>
              <div id="price-body" class="mt-3">
                <div class="space-y-2">
                  <div class="flex items-center"><input type="radio" id="price-all" name="price" value="all" checked class="filter-price mr-2"><label for="price-all" class="text-sm">All Prices</label></div>
                  <div class="flex items-center"><input type="radio" id="price-1" name="price" value="under200" class="filter-price mr-2"><label for="price-1" class="text-sm">Under $200</label></div>
                  <div class="flex items-center"><input type="radio" id="price-2" name="price" value="200-500" class="filter-price mr-2"><label for="price-2" class="text-sm">$200 - $500</label></div>
                  <div class="flex items-center"><input type="radio" id="price-3" name="price" value="500-1000" class="filter-price mr-2"><label for="price-3" class="text-sm">$500 - $1,000</label></div>
                </div>
              </div>
            </div>

            <button id="applyFiltersBtn" class="w-full bg-amber-600 hover:bg-amber-700 text-black py-2 rounded-md monument">Apply Filters</button>
          </div>
        </aside>

        <main class="md:w-3/4 monument">
          <div class="flex justify-between items-center mb-8">
            <div>
              <span id="showingText" style="color:var(--black);">Showing 0 of 0 products</span>
              <!-- Applied filters pill will be injected here -->
              <div id="appliedFiltersWrap" style="display:inline-block; margin-left:12px; vertical-align:middle;"></div>
            </div>

            <div class="flex items-baseline sort-row">
              <span class="mr-2 text-gray-600 text-sm" style="color:var(--black);">Sort by:</span>
              <div class="select-with-icon">
                <i data-feather="chevron-down" class="w-4 h-4"></i>
                <select id="sortSelect" class="text-black rounded-md text-sm">
                  <option value="featured">Featured</option>
                  <option value="price-asc">Price: Low to High</option>
                  <option value="price-desc">Price: High to Low</option>
                  <option value="newest">Newest Arrivals</option>
                  <option value="best-selling">Best Selling</option>
                </select>
              </div>
            </div>
          </div>

          <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>

          <div class="flex justify-center mt-12"><nav id="pagination" class="flex items-center space-x-2"></nav></div>
        </main>
      </div>
    </div>
  </section>

  <footer class="py-12">
    <div class="container mx-auto px-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
        <div>
          <h3 class="monument text-xl mb-4" style="font-weight:900;">Grin & Glisten</h3>
          <p class="mb-4">Custom grillz and street jewelry crafted with precision and attitude.</p>
        </div>
        <div>
          <h4 class="monument font-medium mb-4">Shop</h4>
          <ul class="space-y-2">
            <li><a href="/AllProducts/" class="text-sm">All Products</a></li>
            <li><a href="/Grillz/" class="text-sm">Grillz</a></li>
            <li><a href="/NailJewelry/" class="text-sm">Nail Jewelry</a></li>
            <li><a href="/Earrings/" class="text-sm">Earrings</a></li>
            <li><a href="/VEERWEAR/" class="veerwear text-sm">Veerwear</a></li>
            <li><a href="/aLvaLemerCh/" class="plunct text-sm">aL vaLe</a></li>
          </ul>
        </div>
        <div>
          <h4 class="monument font-medium mb-4">Support</h4>
          <ul class="space-y-2">
            <li><a href="/HowToOrder/" class="text-sm">How to Order</a></li>
            <li><a href="/ImpressionKit/" class="text-sm">Impression Kit</a></li>
            <li><a href="/contact/" class="text-sm">Contact Us</a></li>

          </ul>
        </div>
        <div>
          <h4 class="monument font-medium mb-4">Legal</h4>
          <ul class="space-y-2">
            <li><a href="/TermsandConditions/" class="text-sm">Terms & Conditions</a></li>
          </ul>
        </div>
      </div>
      <div class="border-t mt-12 pt-8 text-center text-sm" style="border-color:#111;">
        <p>© 2025 Grin & Glisten. All rights reserved. <span class="plunct">aL vaLe</span> music subsidiary.</p>
      </div>
    </div>
  </footer>

  <!-- Snipcart root -->
  <div hidden id="snipcart" data-api-key="YOUR_SNIPCART_API_KEY"></div>

  <script>
    feather.replace();

    // Mobile nav toggle
    const mobileBtn = document.getElementById('mobileMenuBtn');
    const mobileNav = document.getElementById('mobileNav');
    const mobileClose = document.getElementById('mobileCloseBtn');
    mobileBtn?.addEventListener('click', ()=> {
      mobileNav.style.display='block';
      document.body.classList.remove('mobile-search-open'); // don't auto-open mobile search here
    });
    mobileClose?.addEventListener('click', ()=> {
      mobileNav.style.display='none';
      // also clear mobile search
      const mIn = document.getElementById('mobileSearchInput');
      if(mIn) mIn.value = '';
      document.body.classList.remove('mobile-search-open');
    });

    // Filter collapse behavior (chevrons to the right)
    document.querySelectorAll('.filter-toggle').forEach(btn=>{
      const target = document.getElementById(btn.getAttribute('data-target'));
      const chev = btn.querySelector('.chev');
      if(target) target.style.display='block';
      if(chev) chev.classList.add('open');
      btn.addEventListener('click', ()=>{
        if(!target) return;
        const none = getComputedStyle(target).display === 'none';
        target.style.display = none ? 'block' : 'none';
        chev?.classList.toggle('open', none);
      });
    });

    /* --------------------------
       Subtype map & enhancements to products
       + slug normalization tables (canonical slug: style=full-cover-sets)
    -------------------------- */
    const subtypesMap = {
      'Earrings': ['Hoops','Studs','Dangles'],
      'Nail Jewelry': ['Full-Cover Press-Ons','Accent Tips','Resin-Embedded Nails'],
      'Grillz': ['Full-Cover Sets','Half-Cover / Open-Face','Top Sets','Bottom Sets','Single-Tooth / Cap','Resin-Embedded Specials']
      // removed 'aL vaLe' and 'Veerwear' subtypes since those categories were removed from demo data
    };

    // canonical slug for each displayed subtype (use these in your category pages when building links)
    const displayToSlug = {
      'Full-Cover Sets': 'full-cover-sets',
      'Half-Cover / Open-Face': 'half-cover-open-face',
      'Top Sets': 'top-sets',
      'Bottom Sets': 'bottom-sets',
      'Single-Tooth / Cap': 'single-tooth-cap',
      'Resin-Embedded Specials': 'resin-embedded-specials',

      'Hoops': 'hoops',
      'Studs': 'studs',
      'Dangles': 'dangles',

      'Full-Cover Press-Ons': 'full-cover-press-ons',
      'Accent Tips': 'accent-tips',
      'Resin-Embedded Nails': 'resin-embedded-nails'
    };

    // normalization mapping: keys are normalized slugs; values are display text matching the checkbox values
    // we include many possible alias forms so odd links still work
    const slugToDisplay = {
      // grillz aliases
      'full-cover-sets':'Full-Cover Sets',
      'fullcoversets':'Full-Cover Sets',
      'full-cover_sets':'Full-Cover Sets',
      'full_cover_sets':'Full-Cover Sets',
      'fullcoverset':'Full-Cover Sets',

      'half-cover-open-face':'Half-Cover / Open-Face',
      'half-cover_open-face':'Half-Cover / Open-Face',
      'halfcoveropenface':'Half-Cover / Open-Face',
      'halfcoversets':'Half-Cover / Open-Face',

      'top-sets':'Top Sets','topsets':'Top Sets','tops':'Top Sets',
      'bottom-sets':'Bottom Sets','bottomsets':'Bottom Sets','bottoms':'Bottom Sets',

      'single-tooth-cap':'Single-Tooth / Cap','single-tooth':'Single-Tooth / Cap','cap':'Single-Tooth / Cap','singletoothcap':'Single-Tooth / Cap',

      'resin-embedded-specials':'Resin-Embedded Specials','resin-embedded':'Resin-Embedded Specials','resinembeddedspecials':'Resin-Embedded Specials','resin-embedded-special':'Resin-Embedded Specials',

      // earrings
      'hoops':'Hoops','studs':'Studs','dangles':'Dangles',

      // nails
      'full-cover-press-ons':'Full-Cover Press-Ons','full-cover-pressons':'Full-Cover Press-Ons','full-cover-press_on':'Full-Cover Press-Ons','fullcoverpressons':'Full-Cover Press-Ons',
      'accent-tips':'Accent Tips','accenttips':'Accent Tips',
      'resin-embedded-nails':'Resin-Embedded Nails','resin-embedded':'Resin-Embedded Nails','resinnails':'Resin-Embedded Nails'
    };

    // Helper to derive a technique from subtype name (simple heuristic)
    function techniqueFromSubtype(sub) {
      if(!sub) return '';
      const s = sub.toLowerCase();
      if(s.includes('full-cover') || s.includes('full cover')) return 'Full-Cover';
      if(s.includes('resin')) return 'Resin-Embedded';
      if(s.includes('accent') || s.includes('single')) return 'Accent';
      if(s.includes('3d') || s.includes('sculpt')) return '3D Sculpt';
      return '';
    }

    // normalize a slug-ish input into canonical lowercase hyphen form
    function normalizeSlugInput(raw){
      if(!raw) return '';
      let s = String(raw).trim().toLowerCase();
      s = s.replace(/[%20\+_]+/g,'-');       // spaces, plus, underscores -> hyphen
      s = s.replace(/[^\w-]+/g,'-');         // non-word -> hyphen
      s = s.replace(/-+/g,'-');              // collapse multiple hyphens
      s = s.replace(/^-|-$/g,'');            // trim leading/trailing hyphens
      return s;
    }

    // Given a slug supplied via URL, return the human label (matching checkbox values) or null
    function slugToLabel(rawSlug){
      const norm = normalizeSlugInput(rawSlug);
      if(!norm) return null;
      // direct lookup
      if(slugToDisplay[norm]) return slugToDisplay[norm];
      // try a relaxed match by removing vowels? (not necessary now)
      return null;
    }

    /* --------------------------
       Dropdown: attach menu to body (fixed) and robust open/close
       (same approach you already had; binding only once)
    -------------------------- */
    function positionAndBindDropdowns(){
      document.querySelectorAll('.group').forEach(group=>{
        if(group.dataset.dropdownBound === "true") return;
        const label = group.querySelector('.menu-label');
        const menu = group.querySelector('.dropdown-menu');
        const trigger = group.querySelector('.menu-trigger');

        if(!menu || !label || !trigger) return;

        // Move menu to body to escape stacking contexts and allow overlay
        if (!menu.dataset.moved) {
          document.body.appendChild(menu);
          menu.dataset.moved = "true";
          menu.style.position = 'fixed';
          menu.style.willChange = 'top, left, width';
          menu.style.zIndex = 9999;
        }

        // function to compute width & position
        function positionMenu(){
          // --- Make sure we measure the intrinsic content width ---
          const prevDisplay = menu.style.display;
          const prevVisibility = menu.style.visibility;
          menu.style.display = 'block';
          menu.style.visibility = 'hidden';
          menu.style.left = '-9999px';
          menu.style.top = '-9999px';
          menu.style.width = 'auto';
          menu.style.whiteSpace = 'nowrap';

          // measure widest item using scrollWidth (intrinsic content width)
          let maxItemWidth = 0;
          menu.querySelectorAll('a').forEach(a=>{
            const w = a.scrollWidth;
            if(w > maxItemWidth) maxItemWidth = w;
          });

          const cs = getComputedStyle(menu);
          const padLeft = parseFloat(cs.paddingLeft) || 10;
          const padRight = parseFloat(cs.paddingRight) || 10;
          const extraBuffer = 16; // breathing room
          const finalWidth = Math.ceil(maxItemWidth + padLeft + padRight + extraBuffer);
          menu.style.width = finalWidth + 'px';

          // compute left/top so the *text* left aligns with the label left
          const labelRect = label.getBoundingClientRect();
          const triggerRect = trigger.getBoundingClientRect();
          const left = Math.round(labelRect.left - padLeft);
          const top = Math.round(triggerRect.bottom + 8); // 8px gap
          const clampedLeft = Math.max(8, left);
          menu.style.left = clampedLeft + 'px';
          menu.style.top = top + 'px';

          menu.style.visibility = '';
          menu.style.display = group.classList.contains('open') ? 'block' : 'none';
        }

        // open/close helpers with small delay
        let leaveTimer = null;
        const openMenu = ()=> {
          clearTimeout(leaveTimer);
          group.classList.add('open');
          menu.classList.add('open');
          menu.style.display = 'block';
          trigger.setAttribute('aria-expanded','true');
          menu.setAttribute('aria-hidden','false');
          positionMenu(); // ensure accurate pos/width
        };
        const closeMenu = ()=> {
          clearTimeout(leaveTimer);
          leaveTimer = setTimeout(()=> {
            group.classList.remove('open');
            menu.classList.remove('open');
            menu.style.display = 'none';
            trigger.setAttribute('aria-expanded','false');
            menu.setAttribute('aria-hidden','true');
          }, 120);
        };

        // Hover / pointer interactions
        group.addEventListener('pointerenter', openMenu);
        group.addEventListener('pointerleave', closeMenu);
        menu.addEventListener('pointerenter', openMenu);
        menu.addEventListener('pointerleave', closeMenu);

        // Focus interactions for keyboard users
        trigger.addEventListener('focus', openMenu);
        trigger.addEventListener('blur', ()=>{
          leaveTimer = setTimeout(()=> {
            const active = document.activeElement;
            if(menu.contains(active)) return;
            closeMenu();
          }, 120);
        });

        // Click toggle (touch/pointer)
        trigger.addEventListener('click', (e)=>{
          e.preventDefault();
          e.stopPropagation();
          if(group.classList.contains('open')) {
            closeMenu();
          } else {
            openMenu();
          }
        });

        // Click outside -> close
        const outsideHandler = (ev) => {
          if (!trigger.contains(ev.target) && !menu.contains(ev.target)) {
            closeMenu();
          }
        };
        document.addEventListener('click', outsideHandler);

        // reposition on resize & scroll so menu stays aligned
        const repositionOnResize = () => { if (group.classList.contains('open')) positionMenu(); };
        window.addEventListener('resize', repositionOnResize);
        window.addEventListener('scroll', repositionOnResize, { passive: true });

        // close on Escape
        document.addEventListener('keydown', (ev)=> {
          if(ev.key === 'Escape') closeMenu();
        });

        group.dataset.dropdownBound = "true";
      });
    }

    // Call on load and resize (binding only happens once per group)
    window.addEventListener('resize', ()=> positionAndBindDropdowns());
    document.addEventListener('DOMContentLoaded', ()=>{
      feather.replace();
      positionAndBindDropdowns();

      // build products (now with subtype + technique)
      buildDemoProducts();

      // apply URL-driven filters BEFORE reading filters so UI reflects URL state
      applyUrlDrivenFiltersFromUrl();

      // rest of your initialization (filters/products/pagination)
      readFiltersFromUI();
      currentSort = document.getElementById('sortSelect').value || 'featured';
      renderProducts();

      // init search interactions
      initHeaderSearch();
      initMobileSearch();
    });

    /* --------------------------
       Product generator: now adds subtype + technique
    -------------------------- */
    const categories = ['Grillz','Earrings','Nail Jewelry','Accessories']; // Removed 'aL vaLe' and 'Veerwear' so demo products won't include them
    const materials = ['Gold','Silver','Platinum','With Diamonds','Resin'];
    const products = [];
    const TOTAL_ITEMS = 86;
    function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

    function buildDemoProducts(){
      products.length = 0;
      for(let i=1;i<=TOTAL_ITEMS;i++){
        const cat = categories[i % categories.length];
        const mat = materials[i % materials.length];
        const price = (i % 10 === 0) ? rand(1200,3500) : rand(50,1200);
        const sold = rand(0,2000);
        const featured = i % 7 === 0;
        const date = new Date(Date.now() - rand(0,365)*24*3600*1000).toISOString();

        // pick subtype appropriate to category
        const pool = subtypesMap[cat] || ['General'];
        const subtype = pool[rand(0, pool.length-1)];
        const technique = techniqueFromSubtype(subtype) || (Math.random() < 0.12 ? '3D Sculpt' : '');

        products.push({
          id:i,
          title:`${subtype} Item ${i}`,
          description:`${mat} · ${cat} · ${subtype}`,
          image:`/images/placeholder-${(i%10)+1}.jpg`,
          price,
          category:cat,
          material:mat,
          subtype,
          technique,
          soldCount:sold,
          featured,
          date
        });
      }
    }

    // State (pagination / filters / sort)
    let currentPage = 1;
    const pageSize = 24;
    let currentFilters = { categories:[], materials:[], price:'all', subtypes:[], techniques:[] };
    let currentSort = 'featured';

    // favorites - localStorage
    function readFavorites(){ try{ return new Set(JSON.parse(localStorage.getItem('sb_favorites')||'[]')); }catch(e){ return new Set(); } }
    function writeFavorites(set){ const arr = Array.from(set); localStorage.setItem('sb_favorites', JSON.stringify(arr)); }
    function toggleFavorite(id){ const s = readFavorites(); if(s.has(id)) s.delete(id); else s.add(id); writeFavorites(s); renderProducts(); }

    function priceMatch(price, filterKey){
      if(!filterKey||filterKey==='all') return true;
      if(filterKey==='under200') return price < 200;
      if(filterKey==='200-500') return price >=200 && price <=500;
      if(filterKey==='500-1000') return price >500 && price <=1000;
      if(filterKey==='over1000') return price >1000;
      return true;
    }

    function applyFiltersAndSort(){
      let out = products.slice();

      // category
      if(currentFilters.categories.length) out = out.filter(p => currentFilters.categories.includes(p.category));

      // material
      if(currentFilters.materials.length) out = out.filter(p => currentFilters.materials.includes(p.material));

      // subtype
      if(currentFilters.subtypes.length) out = out.filter(p => currentFilters.subtypes.includes(p.subtype));

      // technique
      if(currentFilters.techniques.length) out = out.filter(p => currentFilters.techniques.includes(p.technique));

      // price
      if(currentFilters.price && currentFilters.price !== 'all') out = out.filter(p => priceMatch(p.price, currentFilters.price));

      // sort
      if(currentSort==='price-asc') out.sort((a,b)=>a.price-b.price);
      else if(currentSort==='price-desc') out.sort((a,b)=>b.price-a.price);
      else if(currentSort==='newest') out.sort((a,b)=>new Date(b.date)-new Date(a.date));
      else if(currentSort==='best-selling') out.sort((a,b)=>b.soldCount-a.soldCount);
      else out.sort((a,b)=> (b.featured?1:0) - (a.featured?1:0));

      return out;
    }

    function renderProducts(){
      const grid = document.getElementById('productGrid');
      grid.innerHTML = '';
      const filtered = applyFiltersAndSort();
      const total = filtered.length;
      const start = (currentPage-1)*pageSize;
      const pageItems = filtered.slice(start, start + pageSize);
      document.getElementById('showingText').textContent = `Showing ${pageItems.length} of ${total} products`;
      const favSet = readFavorites();

      for(const p of pageItems){
        let fontClass = 'monument';
        // since categories 'Veerwear' and 'aL vaLe' are no longer generated, these conditions remain harmless
        if(p.category==='Veerwear') fontClass='veerwear';
        else if(p.category==='aL vaLe') fontClass='plunct';
        const heartActive = favSet.has(p.id);

        const card = document.createElement('div');
        card.className = 'bg-white rounded-lg overflow-hidden product-card';
        card.innerHTML = `
          <div class="relative overflow-hidden h-64">
            <img src="${p.image}" alt="${p.title}" class="w-full h-full object-cover">
            <div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent"></div>
            ${p.featured ? `<div class="absolute top-3 left-3 badge-gold">BESTSELLER</div>` : ''}
            <button class="absolute top-3 right-3 heart-btn ${heartActive ? 'heart-active' : ''}" data-id="${p.id}" title="Save to favorites">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 ${heartActive ? '' : ''}" viewBox="0 0 24 24" fill="${heartActive ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z"/></svg>
            </button>
          </div>
          <div class="p-4">
            <h3 class="font-medium mb-1 ${fontClass}" style="color:var(--black);">${p.title}</h3>
            <p class="${fontClass} text-gray-600 text-sm mb-2" style="color:var(--black);">${p.description}</p>
            <div class="flex justify-between items-center">
              <span class="${fontClass} font-bold" style="color:var(--black);">$${p.price.toLocaleString()}</span>

              <button class="snipcart-add-item inline-flex items-center px-3 py-2 rounded text-sm border border-transparent bg-amber-600 hover:bg-amber-700"
                data-item-id="${p.id}"
                data-item-name="${p.title}"
                data-item-price="${p.price}"
                data-item-url="/AllProducts/"
                data-item-description="${p.description}"
                data-item-image="${p.image}">
                Add to cart
              </button>
            </div>
          </div>
        `;
        grid.appendChild(card);
      }

      // bind heart toggles
      document.querySelectorAll('.heart-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = Number(btn.getAttribute('data-id'));
          toggleFavorite(id);
        });
      });

      feather.replace();
      renderPagination(filtered.length);
    }

    function renderPagination(totalFiltered){
      const pagination = document.getElementById('pagination'); pagination.innerHTML='';
      const totalPages = Math.max(1, Math.ceil(totalFiltered / pageSize));

      function makeNavButton(iconName, onClick, disabled=false){
        const b = document.createElement('button');
        b.className = 'nav-btn';
        if(disabled) b.setAttribute('disabled','true');
        b.innerHTML = `<i data-feather="${iconName}" class="w-4 h-4"></i>`;
        b.addEventListener('click', (e)=>{ if(disabled) return; b.classList.add('clicked'); setTimeout(()=>b.classList.remove('clicked'),140); onClick(e); });
        pagination.appendChild(b);
        return b;
      }

      // prev
      makeNavButton('chevron-left', ()=>{
        if(currentPage > 1){ currentPage--; renderProducts(); }
      }, currentPage === 1);

      function pageBtn(page){
        const b = document.createElement('button');
        b.className = 'page-btn';
        b.textContent = String(page);
        if(page === currentPage) b.classList.add('page-active');
        b.addEventListener('click', ()=>{
          if(page === currentPage) {
            b.classList.add('clicked');
            setTimeout(()=>b.classList.remove('clicked'),120);
            return;
          }
          b.classList.add('clicked');
          setTimeout(()=>b.classList.remove('clicked'),120);
          currentPage = page;
          renderProducts();
        });
        ['mousedown','touchstart'].forEach(ev => b.addEventListener(ev, ()=> b.classList.add('clicked')));
        ['mouseup','mouseleave','touchend','touchcancel'].forEach(ev => b.addEventListener(ev, ()=> b.classList.remove('clicked')));
        pagination.appendChild(b);
      }

      if(totalPages <= 8){
        for(let p=1;p<=totalPages;p++) pageBtn(p);
      } else {
        pageBtn(1);
        pageBtn(2);
        if(currentPage > 4){
          const dots = document.createElement('span'); dots.className='px-2'; dots.textContent='...'; pagination.appendChild(dots);
        }
        const start = Math.max(3, Math.min(currentPage-1, totalPages-4));
        const end = Math.min(totalPages-2, start + 2);
        for(let p=start;p<=end;p++) pageBtn(p);
        if(end < totalPages-2){
          const dots2 = document.createElement('span'); dots2.className='px-2'; dots2.textContent='...'; pagination.appendChild(dots2);
        }
        pageBtn(totalPages-1);
        pageBtn(totalPages);
      }

      // next
      makeNavButton('chevron-right', ()=>{
        if(currentPage < Math.ceil(totalFiltered / pageSize)){ currentPage++; renderProducts(); }
      }, currentPage === Math.ceil(totalFiltered / pageSize));

      feather.replace();
    }

    function readFiltersFromUI(){
      currentFilters.categories = Array.from(document.querySelectorAll('.filter-cat:checked')).map(i=>i.value);
      currentFilters.materials = Array.from(document.querySelectorAll('.filter-material:checked')).map(i=>i.value);
      currentFilters.subtypes = Array.from(document.querySelectorAll('.filter-subtype:checked')).map(i=>i.value);
      currentFilters.techniques = Array.from(document.querySelectorAll('.filter-tech:checked')).map(i=>i.value);
      const priceRadio = document.querySelector('.filter-price:checked');
      currentFilters.price = priceRadio ? priceRadio.value : 'all';

      // update applied filters pill if any were applied via URL (we will store that state on window._urlAppliedFilters)
      updateAppliedFiltersPill();
    }

    document.getElementById('applyFiltersBtn').addEventListener('click', ()=>{ readFiltersFromUI(); currentPage = 1; renderProducts(); });
    document.getElementById('sortSelect').addEventListener('change', e => { currentSort = e.target.value; currentPage = 1; renderProducts(); });

    /* --------------------------
       Cart toggle behavior (unchanged)
    -------------------------- */
    const headerCartToggle = document.getElementById('headerCartToggle');
    let cartOpen = false;
    document.addEventListener('snipcart.ready', ()=>{ cartOpen = false; });
    document.addEventListener('snipcart.opened', ()=>{ cartOpen = true; });
    document.addEventListener('snipcart.closed', ()=>{ cartOpen = false; });

    headerCartToggle?.addEventListener('click', (e)=>{
      e.preventDefault();
      headerCartToggle.classList.add('clicked');
      setTimeout(()=> headerCartToggle.classList.remove('clicked'), 140);

      if(window.Snipcart && window.Snipcart.api && window.Snipcart.api.modal){
        if(cartOpen) window.Snipcart.api.modal.close();
        else window.Snipcart.api.modal.open();
      } else {
        const anchor = document.querySelector('a.snipcart-checkout');
        if(anchor){ anchor.click(); } else { console.warn('Snipcart not initialized yet.'); }
      }
    });

    /* --------------------------
       SEARCH UI: desktop & mobile behavior
    -------------------------- */
    function initHeaderSearch(){
      const wrap = document.getElementById('desktopSearchWrap');
      const form = document.getElementById('headerSearchForm');
      const input = document.getElementById('headerSearchInput');
      const btn = document.getElementById('headerSearchBtn');

      if(!wrap || !form || !input || !btn) return;

      function isMobile() { return window.matchMedia('(max-width:767px)').matches; }

      btn.addEventListener('click', (ev) => {
        if (isMobile()) {
          openMobileSearchAndFocus();
          ev.preventDefault();
          return;
        }
        const isOpen = wrap.classList.contains('open');
        if(!isOpen) {
          ev.preventDefault();
          wrap.classList.add('open');
          setTimeout(()=> input.focus(), 80);
          return;
        }
      });

      form.addEventListener('submit', (ev) => {
        ev.preventDefault();
        const q = (input.value || '').trim();
        if(!q) {
          wrap.classList.remove('open');
          input.value = '';
          return;
        }
        wrap.classList.remove('open');
        const valueToSend = q;
        input.value = '';
        setTimeout(()=> {
          window.location.href = '/search.html?q=' + encodeURIComponent(valueToSend);
        }, 40);
      });

      document.addEventListener('click', (ev) => {
        if(!wrap.contains(ev.target)) {
          wrap.classList.remove('open');
          input.value = '';
        }
      });

      document.addEventListener('keydown', (ev) => {
        if(ev.key === 'Escape') {
          wrap.classList.remove('open');
          input.value = '';
        }
      });
    }

    // Mobile search: show mobile nav and focus the mobile input.
    function initMobileSearch(){
      const mobileForm = document.getElementById('mobileSearchForm');
      const mobileInput = document.getElementById('mobileSearchInput');

      if(mobileForm){
        mobileForm.addEventListener('submit', (ev)=>{
          ev.preventDefault();
          const q = (mobileInput.value || '').trim();
          if(!q) return;
          mobileNav.style.display = 'none';
          document.body.classList.remove('mobile-search-open');
          mobileInput.value = '';
          setTimeout(()=> {
            window.location.href = '/search.html?q=' + encodeURIComponent(q);
          }, 60);
        });
      }
    }

    function openMobileSearchAndFocus(){
      const mobileSearchBar = document.getElementById('mobileSearchBar');
      const mobileInput = document.getElementById('mobileSearchInput');
      if(mobileNav.style.display === 'none' || mobileNav.style.display === '') {
        mobileNav.style.display = 'block';
      }
      document.body.classList.add('mobile-search-open');
      setTimeout(()=> {
        if(mobileInput) mobileInput.focus();
      }, 60);
    }

    /* --------------------------
       ========== URL-driven filters glue ==========
       - Reads ?category=...&style=... and auto-applies (also supports comma-separated styles)
       - Normalizes many slug variants to the checkbox label
       - Shows an "Applied filters" pill with clear button
    -------------------------- */
    // store what URL-driven filters were applied (for showing the pill)
    window._urlAppliedFilters = { category: null, subtypes: [] };

    function applyUrlDrivenFiltersFromUrl(){
      const params = new URLSearchParams(window.location.search);
      const catParam = params.get('category');
      const styleParam = params.get('style'); // e.g. "full-cover-sets" or "half-cover_open-face"

      if(!catParam && !styleParam) return; // nothing to do

      // Normalize category -- match by case-insensitive value on checkboxes
      if(catParam){
        const catNorm = catParam.trim().toLowerCase();
        const catInputs = Array.from(document.querySelectorAll('.filter-cat'));
        const matched = catInputs.find(i => i.value && i.value.toLowerCase() === catNorm);
        if(matched){
          matched.checked = true;
          window._urlAppliedFilters.category = matched.value;
          // open category filter block for clarity
          openFilterSection('category-body');
        } else {
          // attempt looser match (replace hyphens/underscores)
          const catCandidate = catNorm.replace(/[-_]+/g,' ');
          const matched2 = catInputs.find(i => i.value && i.value.toLowerCase() === catCandidate);
          if(matched2){
            matched2.checked = true;
            window._urlAppliedFilters.category = matched2.value;
            openFilterSection('category-body');
          }
        }
      }

      // style may be comma-separated. handle multiple styles
      if(styleParam){
        const styleParts = styleParam.split(',').map(s => s.trim()).filter(Boolean);
        for(const raw of styleParts){
          const label = slugToLabel(raw);
          if(label){
            // check matching subtype checkbox (exact value match)
            const subInputs = Array.from(document.querySelectorAll('.filter-subtype'));
            const match = subInputs.find(i => i.value === label);
            if(match){
              match.checked = true;
              window._urlAppliedFilters.subtypes.push(label);
              // open subtype filter block
              openFilterSection('subtype-body');
              // try also to enable technique if derivable
              const tech = techniqueFromSubtype(label);
              if(tech){
                const techInput = Array.from(document.querySelectorAll('.filter-tech')).find(i => i.value === tech);
                if(techInput){
                  techInput.checked = true;
                  // ensure feature-body open
                  openFilterSection('feature-body');
                }
              }
            } else {
              // attempt case-insensitive compare if exact doesn't match
              const match2 = Array.from(document.querySelectorAll('.filter-subtype')).find(i => i.value.toLowerCase() === label.toLowerCase());
              if(match2){
                match2.checked = true;
                window._urlAppliedFilters.subtypes.push(match2.value);
                openFilterSection('subtype-body');
              }
            }
          } else {
            // If slug didn't resolve, attempt to treat raw as decoded label
            const decoded = decodeURIComponent(raw).replace(/[-_]+/g,' ').trim();
            const match3 = Array.from(document.querySelectorAll('.filter-subtype')).find(i => i.value.toLowerCase() === decoded.toLowerCase());
            if(match3){
              match3.checked = true;
              window._urlAppliedFilters.subtypes.push(match3.value);
              openFilterSection('subtype-body');
            }
          }
        } // for parts
      } // if styleParam

      // If any URL-driven filters were set, update UI state & pill immediately
      if(window._urlAppliedFilters.category || (window._urlAppliedFilters.subtypes && window._urlAppliedFilters.subtypes.length)){
        // read filters into state and renderProducts will apply them
        readFiltersFromUI();
      }
    }

    // opens a filter panel by ID and toggles its chevron to "open"
    function openFilterSection(sectionId){
      const el = document.getElementById(sectionId);
      if(!el) return;
      el.style.display = 'block';
      // find the toggle button that points to this target
      const btn = document.querySelector(`.filter-toggle[data-target="${sectionId}"]`);
      if(btn){
        const chev = btn.querySelector('.chev');
        if(chev) chev.classList.add('open');
      } else {
        // fallback: try to locate a button with matching data-target attribute (older markup)
        const maybe = Array.from(document.querySelectorAll('.filter-toggle')).find(b => b.getAttribute('data-target') === sectionId);
        if(maybe) maybe.querySelector('.chev')?.classList.add('open');
      }
    }

    // build the pill text and show it in the appliedFiltersWrap
    function updateAppliedFiltersPill(){
      const wrap = document.getElementById('appliedFiltersWrap');
      if(!wrap) return;
      // If pill was created by URL application, reflect it
      const cat = window._urlAppliedFilters.category;
      const subs = window._urlAppliedFilters.subtypes || [];

      // If there are no URL-applied filters, remove pill area
      if(!cat && (!subs || subs.length === 0)){
        wrap.innerHTML = '';
        return;
      }

      // Build pill content: show primary category then first subtype if present
      const parts = [];
      if(cat) parts.push(cat);
      if(subs.length) parts.push(subs.join(' • ')); // show multiple subtypes separated with dot
      const pillText = parts.join(' › ');

      wrap.innerHTML = `<span class="applied-pill" role="status" aria-live="polite">
        Filters applied: ${escapeHtml(pillText)}
        <button class="pill-close" title="Clear URL filters" aria-label="Clear filters">&times;</button>
      </span>`;

      // wire the clear button
      const btn = wrap.querySelector('.pill-close');
      if(btn){
        btn.addEventListener('click', ()=> {
          clearUrlDrivenFilters();
        });
      }
    }

    // clear the URL-driven filters: uncheck those that were set and remove query params
    function clearUrlDrivenFilters(){
      // uncheck category if set
      if(window._urlAppliedFilters.category){
        const catInput = Array.from(document.querySelectorAll('.filter-cat')).find(i => i.value === window._urlAppliedFilters.category);
        if(catInput) catInput.checked = false;
      }
      // uncheck subtype inputs that were set
      (window._urlAppliedFilters.subtypes || []).forEach(lbl => {
        const inpt = Array.from(document.querySelectorAll('.filter-subtype')).find(i => i.value === lbl);
        if(inpt) inpt.checked = false;
      });

      // uncheck technique derived checkboxes (best-effort)
      const allTechInputs = Array.from(document.querySelectorAll('.filter-tech'));
      allTechInputs.forEach(i => { i.checked = false; });

      // reset our memory
      window._urlAppliedFilters = { category:null, subtypes:[] };

      // update current filters and UI
      readFiltersFromUI();
      currentPage = 1;
      renderProducts();

      // remove 'category' and 'style' from URL (preserve other params) using replaceState
      const url = new URL(window.location.href);
      url.searchParams.delete('category');
      url.searchParams.delete('style');
      history.replaceState(null, '', url.toString());
    }

    /* --------------------------
       small helpers
    -------------------------- */
    function escapeHtml(s) {
      if(!s) return '';
      return String(s).replace(/[&<>"']/g, function (m) { return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
    }

  </script>
</body>
</html>
